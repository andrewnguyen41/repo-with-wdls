#!/bin/bash

cd /cromwell_root
tmpDir=$(mkdir -p "/cromwell_root/tmp.a167e2c1" && echo "/cromwell_root/tmp.a167e2c1")
chmod 777 "$tmpDir"
export _JAVA_OPTIONS=-Djava.io.tmpdir="$tmpDir"
export TMPDIR="$tmpDir"
export HOME="$HOME"
(
cd /cromwell_root

)
outbf9a51e0="${tmpDir}/out.$$" errbf9a51e0="${tmpDir}/err.$$"
mkfifo "$outbf9a51e0" "$errbf9a51e0"
trap 'rm "$outbf9a51e0" "$errbf9a51e0"' EXIT
touch '/cromwell_root/stdout' '/cromwell_root/stderr'
tee '/cromwell_root/stdout' < "$outbf9a51e0" &
tee '/cromwell_root/stderr' < "$errbf9a51e0" >&2 &
(
cd /cromwell_root


set -o errexit -o nounset -o xtrace -o pipefail

echo "project_id = terra-cold-pecan-4945" > ~/.bigqueryrc
TABLE="gvs_1.cost_observability"

# Check that the table has not been created yet
set +o errexit
bq show --project_id terra-cold-pecan-4945 $TABLE > /dev/null
BQ_SHOW_RC=$?
set -o errexit

if [ $BQ_SHOW_RC -ne 0 ]; then
  PARTITION_STRING="--time_partitioning_field call_start_timestamp --time_partitioning_type DAY"
  echo "making table $TABLE"
  echo '[ { "name": "call_set_identifier", "type": "STRING", "mode": "REQUIRED", "description": "The name by which we refer to the callset" },   { "name": "step", "type": "STRING", "mode": "REQUIRED", "description": "The name of the core GVS workflow to which this belongs" },   { "name": "call", "type": "STRING", "mode": "NULLABLE", "description": "The WDL call to which this belongs" },   { "name": "shard_identifier", "type": "STRING", "mode": "NULLABLE", "description": "A unique identifier for this shard, may or may not be its index" },   { "name": "call_start_timestamp", "type": "TIMESTAMP", "mode": "REQUIRED", "description": "When the call logging this event was started" },   { "name": "event_timestamp", "type": "TIMESTAMP", "mode": "REQUIRED", "description": "When the observability event was logged" },   { "name": "event_key", "type": "STRING", "mode": "REQUIRED", "description": "The type of observability event being logged" },   { "name": "event_bytes", "type": "INTEGER", "mode": "REQUIRED", "description": "Number of bytes reported for this observability event" } ] ' > schema.json
  bq mk ${PARTITION_STRING} --project_id=terra-cold-pecan-4945 $TABLE schema.json
fi
)  > "$outbf9a51e0" 2> "$errbf9a51e0"
echo $? > /cromwell_root/rc.tmp
(
# add a .file in every empty directory to facilitate directory delocalization on the cloud
cd /cromwell_root
find . -type d -exec sh -c '[ -z "$(ls -A '"'"'{}'"'"')" ] && touch '"'"'{}'"'"'/.file' \;
)
(
cd /cromwell_root
sync


)
mv /cromwell_root/rc.tmp /cromwell_root/rc
